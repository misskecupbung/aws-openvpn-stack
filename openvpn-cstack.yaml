AWSTemplateFormatVersion: '2010-09-09'
Description: >-
  Creates a VPC with a public subnet, Internet Gateway, Route Table, Network ACL, 
  Security Group, S3 bucket, IAM Role and an EC2 instance that installs OpenVPN, generates
  a client .ovpn profile and uploads it to the S3 bucket.

Parameters:
  EnvironmentName:
    Type: String
    Default: dev
    Description: Prefix/name tag for resources.
  VpcCidr:
    Type: String
    Default: 10.20.0.0/16
    AllowedPattern: '(?:\d{1,3}\.){3}\d{1,3}/\d{1,2}'
    Description: CIDR block for the VPC.
  PublicSubnetCidr:
    Type: String
    Default: 10.20.1.0/24
    AllowedPattern: '(?:\d{1,3}\.){3}\d{1,3}/\d{1,2}'
    Description: CIDR for the public subnet.
  AllowedClientCidr:
    Type: String
    Default: 0.0.0.0/0
    Description: CIDR allowed to access OpenVPN (restrict in production!).
  InstanceType:
    Type: String
    Default: t3.micro
    AllowedValues:
      - t3.nano
      - t3.micro
      - t3.small
      - t3.medium
      - t3.large
    Description: EC2 instance type for OpenVPN server.
  KeyPairName:
    Type: AWS::EC2::KeyPair::KeyName
    Description: Existing EC2 KeyPair name for SSH access.
  BucketName:
    Type: String
    Description: S3 bucket name (must be globally unique).
  LatestAmiId:
    Type: AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>
    Default: /aws/service/canonical/ubuntu/server/24.04/stable/current/amd64/hvm/ebs-gp3/ami-id
    Description: SSM parameter for latest Ubuntu 24.04 LTS AMI.
  NotificationEmail:
    Type: String
    Description: Email address to receive notification when OVPN file is ready.

Resources:
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !Ref VpcCidr
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-vpc'

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-igw'

  VPCGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway

  PublicSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Ref PublicSubnetCidr
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-public-1a'

  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-public-rt'

  PublicRoute:
    Type: AWS::EC2::Route
    DependsOn: VPCGatewayAttachment
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  PublicSubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet
      RouteTableId: !Ref PublicRouteTable

  PublicNetworkAcl:
    Type: AWS::EC2::NetworkAcl
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-public-nacl'

  InboundPublicNetworkAclEntryAllowEphemeral:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref PublicNetworkAcl
      RuleNumber: 100
      Protocol: 6 # TCP
      RuleAction: allow
      Egress: false
      CidrBlock: 0.0.0.0/0
      PortRange:
        From: 1024
        To: 65535

  InboundPublicNetworkAclEntryAllowSSH:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref PublicNetworkAcl
      RuleNumber: 110
      Protocol: 6 # TCP
      RuleAction: allow
      Egress: false
      CidrBlock: !Ref AllowedClientCidr
      PortRange:
        From: 22
        To: 22

  InboundPublicNetworkAclEntryAllowOpenVPN:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref PublicNetworkAcl
      RuleNumber: 120
      Protocol: 17 # UDP (default OpenVPN uses UDP 1194)
      RuleAction: allow
      Egress: false
      CidrBlock: !Ref AllowedClientCidr
      PortRange:
        From: 1194
        To: 1194

  OutboundPublicNetworkAclEntryAll:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref PublicNetworkAcl
      RuleNumber: 100
      Protocol: -1
      RuleAction: allow
      Egress: true
      CidrBlock: 0.0.0.0/0

  PublicSubnetNaclAssociation:
    Type: AWS::EC2::SubnetNetworkAclAssociation
    Properties:
      SubnetId: !Ref PublicSubnet
      NetworkAclId: !Ref PublicNetworkAcl

  OpenVpnSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for OpenVPN EC2 instance
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref AllowedClientCidr
        - IpProtocol: udp
          FromPort: 1194
          ToPort: 1194
          CidrIp: !Ref AllowedClientCidr
      SecurityGroupEgress:
        - IpProtocol: -1
          FromPort: 0
          ToPort: 0
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-openvpn-sg'

  S3Bucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Ref BucketName
      VersioningConfiguration:
        Status: Enabled
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-openvpn-config'

  BucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref S3Bucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: AllowPutFromInstanceRole
            Effect: Allow
            Principal:
              AWS: !GetAtt InstanceRole.Arn
            Action:
              - s3:PutObject
              - s3:PutObjectAcl
            Resource: !Sub 'arn:aws:s3:::${S3Bucket}/*'

  NotificationTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: !Sub '${EnvironmentName}-openvpn-notifications'

  NotificationSubscription:
    Type: AWS::SNS::Subscription
    Properties:
      Protocol: email
      TopicArn: !Ref NotificationTopic
      Endpoint: !Ref NotificationEmail

  InstanceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      Path: '/'
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
      Policies:
        - PolicyName: S3Access
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:PutObjectAcl
                Resource: !Sub 'arn:aws:s3:::${S3Bucket}/*'
        - PolicyName: SNSPublish
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - sns:Publish
                Resource: !Ref NotificationTopic
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-instance-role'

  InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - !Ref InstanceRole
      Path: '/'

  OpenVpnInstance:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: !Ref InstanceType
      IamInstanceProfile: !Ref InstanceProfile
      KeyName: !Ref KeyPairName
      ImageId: !Ref LatestAmiId
      SubnetId: !Ref PublicSubnet
      SecurityGroupIds:
        - !Ref OpenVpnSecurityGroup
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-openvpn'
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          set -ex
          exec > >(tee /var/log/openvpn-bootstrap.log) 2>&1

          # Wait for network and metadata service
          sleep 10

          # Update and upgrade
          apt-get update && \
          apt-get upgrade -y && \
          apt-get install -y curl unzip

          # Install AWS CLI v2
          curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "/tmp/awscliv2.zip"
          unzip -q /tmp/awscliv2.zip -d /tmp
          /tmp/aws/install
          rm -rf /tmp/awscliv2.zip /tmp/aws

          # Download and run OpenVPN install script
          curl -fsSLO https://raw.githubusercontent.com/angristan/openvpn-install/master/openvpn-install.sh
          chmod +x openvpn-install.sh
          
          # Patch: Skip SHA256 checksum verification (bug in upstream script - checksum mismatch)
          sed -i 's/log_fatal "SHA256 checksum verification failed/log_warn "SHA256 checksum verification failed (ignored)"; # log_fatal "SHA256 checksum verification failed/' openvpn-install.sh
          AUTO_INSTALL=y ./openvpn-install.sh

          # Upload .ovpn file to S3
          OVPN_FILE=$(find /root /home -name "*.ovpn" -type f 2>/dev/null | head -1)
          if [ -n "$OVPN_FILE" ]; then
            aws s3 cp "$OVPN_FILE" s3://${BucketName}/client1.ovpn
            aws sns publish --topic-arn ${NotificationTopic} --region ${AWS::Region} --subject "OpenVPN Ready" --message "Download: aws s3 cp s3://${BucketName}/client1.ovpn ."
          fi

  OpenVpnInstanceEip:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-openvpn-eip'

  OpenVpnInstanceEipAssociation:
    Type: AWS::EC2::EIPAssociation
    Properties:
      AllocationId: !GetAtt OpenVpnInstanceEip.AllocationId
      InstanceId: !Ref OpenVpnInstance

Outputs:
  VpcId:
    Description: VPC ID
    Value: !Ref VPC
  PublicSubnetId:
    Description: Public Subnet ID
    Value: !Ref PublicSubnet
  SecurityGroupId:
    Description: OpenVPN Security Group ID
    Value: !Ref OpenVpnSecurityGroup
  OpenVpnInstanceId:
    Description: EC2 Instance ID
    Value: !Ref OpenVpnInstance
  OpenVpnElasticIp:
    Description: Elastic IP of the OpenVPN server
    Value: !Ref OpenVpnInstanceEip
  S3BucketName:
    Description: S3 bucket storing generated client ovpn file
    Value: !Ref S3Bucket
