AWSTemplateFormatVersion: '2010-09-09'
Description: >-
  Creates a VPC with a public subnet, Internet Gateway, Route Table, Network ACL, 
  Security Group, S3 bucket, IAM Role and an EC2 instance that installs OpenVPN, generates
  a client .ovpn profile and uploads it to the S3 bucket.

Parameters:
  EnvironmentName:
    Type: String
    Default: dev
    Description: Prefix/name tag for resources.
  VpcCidr:
    Type: String
    Default: 10.20.0.0/16
    AllowedPattern: '(?:\d{1,3}\.){3}\d{1,3}/\d{1,2}'
    Description: CIDR block for the VPC.
  PublicSubnetCidr:
    Type: String
    Default: 10.20.1.0/24
    AllowedPattern: '(?:\d{1,3}\.){3}\d{1,3}/\d{1,2}'
    Description: CIDR for the public subnet.
  AllowedClientCidr:
    Type: String
    Default: 0.0.0.0/0
    Description: CIDR allowed to access OpenVPN (restrict in production!).
  InstanceType:
    Type: String
    Default: t3.micro
    AllowedValues:
      - t3.nano
      - t3.micro
      - t3.small
      - t3.medium
      - t3.large
    Description: EC2 instance type for OpenVPN server.
  KeyPairName:
    Type: AWS::EC2::KeyPair::KeyName
    Description: Existing EC2 KeyPair name for SSH access.
  BucketName:
    Type: String
    Description: S3 bucket name (must be globally unique).
  LatestAmiId:
    Type: AWS::SSM::Parameter::Value<String>
    Default: /aws/service/ami-amazon-linux-latest/al2023-ami-kernel-default-arm64
    Description: SSM parameter for latest Amazon Linux AMI. Change arch if needed.
  Architecture:
    Type: String
    Default: arm64
    AllowedValues:
      - x86_64
      - arm64
    Description: CPU architecture to match AMI.

Mappings:
  ArchToAmiParam:
    x86_64:
      AmiParam: /aws/service/ami-amazon-linux-latest/al2023-ami-kernel-default-x86_64
    arm64:
      AmiParam: /aws/service/ami-amazon-linux-latest/al2023-ami-kernel-default-arm64

Resources:
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !Ref VpcCidr
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-vpc'

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-igw'

  VPCGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway

  PublicSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Ref PublicSubnetCidr
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-public-1a'

  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-public-rt'

  PublicRoute:
    Type: AWS::EC2::Route
    DependsOn: VPCGatewayAttachment
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  PublicSubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet
      RouteTableId: !Ref PublicRouteTable

  PublicNetworkAcl:
    Type: AWS::EC2::NetworkAcl
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-public-nacl'

  InboundPublicNetworkAclEntryAllowEphemeral:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref PublicNetworkAcl
      RuleNumber: 100
      Protocol: 6 # TCP
      RuleAction: allow
      Egress: false
      CidrBlock: 0.0.0.0/0
      PortRange:
        From: 1024
        To: 65535

  InboundPublicNetworkAclEntryAllowSSH:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref PublicNetworkAcl
      RuleNumber: 110
      Protocol: 6 # TCP
      RuleAction: allow
      Egress: false
      CidrBlock: !Ref AllowedClientCidr
      PortRange:
        From: 22
        To: 22

  InboundPublicNetworkAclEntryAllowOpenVPN:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref PublicNetworkAcl
      RuleNumber: 120
      Protocol: 17 # UDP (default OpenVPN uses UDP 1194)
      RuleAction: allow
      Egress: false
      CidrBlock: !Ref AllowedClientCidr
      PortRange:
        From: 1194
        To: 1194

  OutboundPublicNetworkAclEntryAll:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref PublicNetworkAcl
      RuleNumber: 100
      Protocol: -1
      RuleAction: allow
      Egress: true
      CidrBlock: 0.0.0.0/0

  PublicSubnetNaclAssociation:
    Type: AWS::EC2::SubnetNetworkAclAssociation
    Properties:
      SubnetId: !Ref PublicSubnet
      NetworkAclId: !Ref PublicNetworkAcl

  OpenVpnSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for OpenVPN EC2 instance
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref AllowedClientCidr
        - IpProtocol: udp
          FromPort: 1194
          ToPort: 1194
          CidrIp: !Ref AllowedClientCidr
      SecurityGroupEgress:
        - IpProtocol: -1
          FromPort: 0
          ToPort: 0
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-openvpn-sg'

  S3Bucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Ref BucketName
      VersioningConfiguration:
        Status: Enabled
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-openvpn-config'

  BucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref S3Bucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: AllowPutFromInstanceRole
            Effect: Allow
            Principal:
              AWS: !GetAtt InstanceRole.Arn
            Action:
              - s3:PutObject
              - s3:PutObjectAcl
            Resource: !Sub 'arn:aws:s3:::${S3Bucket}/*'

  InstanceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      Path: '/'
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
      Policies:
        - PolicyName: S3UploadOpenVpnProfile
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:PutObject
                  - s3:PutObjectAcl
                Resource: !Sub 'arn:aws:s3:::${S3Bucket}/*'
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-instance-role'

  InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - !Ref InstanceRole
      Path: '/'

  OpenVpnInstance:
    Type: AWS::EC2::Instance
    Metadata:
      AWS::CloudFormation::Init:
        config:
          packages:
            yum:
              tar: []
              wget: []
              unzip: []
          files:
            /tmp/openvpn_setup.sh:
              content: !Sub |
                #!/bin/bash
                set -eux
                LOG=/var/log/openvpn-bootstrap.log
                echo "Starting OpenVPN install" > $LOG
                # Install dependencies
                yum install -y curl awscli unzip tar >/dev/null 2>&1 || dnf install -y curl awscli unzip tar
                cd /root
                echo "Downloading OpenVPN install script" >> $LOG
                curl -fsSLO https://raw.githubusercontent.com/angristan/openvpn-install/master/openvpn-install.sh
                chmod +x openvpn-install.sh
                # Headless install with default answers. Adjust env vars if you need custom DNS or protocol.
                export AUTO_INSTALL=y
                # Non-interactive defaults can be overridden via environment variables documented in the project README.
                # Run script; it will create /etc/openvpn/server and a first client when prompted; we auto add one.
                ./openvpn-install.sh >> $LOG 2>&1 || { echo "OpenVPN install failed" >> $LOG; exit 1; }
                # Create initial client config (script normally asks interactively). We emulate add-client.
                CLIENT_NAME=client1
                echo -e "${CLIENT_NAME}\n" | sed 's/.*/&/' > /tmp/clientname.txt
                # Use expect-like here by feeding client name to the add-client function.
                printf "%s\n" "$CLIENT_NAME" | ./openvpn-install.sh --addclient >> $LOG 2>&1 || true
                # Find generated .ovpn file (script places in current dir or /root). Pattern: ${CLIENT_NAME}.ovpn
                OVPN_FILE=$(find /root -maxdepth 2 -name "${CLIENT_NAME}.ovpn" | head -1)
                if [ -z "$OVPN_FILE" ]; then
                  echo "Could not locate client ovpn file" >> $LOG
                  exit 2
                fi
                # Upload to S3
                aws s3 cp "$OVPN_FILE" s3://${BucketName}/${CLIENT_NAME}.ovpn >> $LOG 2>&1 || {
                  echo "S3 upload failed" >> $LOG; exit 3; }
                echo "Completed" >> $LOG
              mode: '000755'
              owner: root
              group: root
          commands:
            01_run_setup:
              command: /tmp/openvpn_setup.sh
    Properties:
      InstanceType: !Ref InstanceType
      IamInstanceProfile: !Ref InstanceProfile
      KeyName: !Ref KeyPairName
      ImageId: !Ref LatestAmiId
      SubnetId: !Ref PublicSubnet
      SecurityGroupIds:
        - !Ref OpenVpnSecurityGroup
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-openvpn'
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          /opt/aws/bin/cfn-init -v --stack ${AWS::StackName} --resource OpenVpnInstance --region ${AWS::Region}
          /opt/aws/bin/cfn-signal -e $? --stack ${AWS::StackName} --resource OpenVpnInstance --region ${AWS::Region}

  OpenVpnInstanceEip:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-openvpn-eip'

  OpenVpnInstanceEipAssociation:
    Type: AWS::EC2::EIPAssociation
    Properties:
      AllocationId: !GetAtt OpenVpnInstanceEip.AllocationId
      InstanceId: !Ref OpenVpnInstance

Outputs:
  VpcId:
    Description: VPC ID
    Value: !Ref VPC
  PublicSubnetId:
    Description: Public Subnet ID
    Value: !Ref PublicSubnet
  SecurityGroupId:
    Description: OpenVPN Security Group ID
    Value: !Ref OpenVpnSecurityGroup
  OpenVpnInstanceId:
    Description: EC2 Instance ID
    Value: !Ref OpenVpnInstance
  OpenVpnElasticIp:
    Description: Elastic IP of the OpenVPN server
    Value: !Ref OpenVpnInstanceEip
  S3BucketName:
    Description: S3 bucket storing generated client ovpn file
    Value: !Ref S3Bucket
