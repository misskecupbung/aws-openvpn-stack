name: Deploy OpenVPN CloudFormation Stack

on:
  workflow_dispatch:
    inputs:
      stack_name:
        description: 'CloudFormation stack name'
        required: true
        default: 'openvpn-dev'
      environment_name:
        description: 'Environment tag prefix'
        required: true
        default: 'dev'
      vpc_cidr:
        description: 'VPC CIDR'
        required: true
        default: '10.20.0.0/16'
      public_subnet_cidr:
        description: 'Public Subnet CIDR'
        required: true
        default: '10.20.1.0/24'
      allowed_client_cidr:
        description: 'CIDR allowed SSH+VPN (e.g. your public /32)'
        required: true
        default: '0.0.0.0/0'
      instance_type:
        description: 'EC2 instance type'
        required: true
        default: 't3.micro'
      key_pair_name:
        description: 'Existing EC2 KeyPair name'
        required: true
        default: 'my-keypair'
      bucket_name:
        description: 'S3 bucket name (global unique)'
        required: true
        default: 'my-unique-openvpn-bucket'
      architecture:
        description: 'Architecture arm64 or x86_64'
        required: true
        default: 'arm64'
  push:
    branches: [ main ]
    paths:
      - 'cloudformation-openvpn-vpc.yaml'
      - '.github/workflows/deploy-openvpn.yml'

permissions:
  id-token: write   # for OIDC federation
  contents: read

jobs:
  deploy:
    name: Deploy CloudFormation
    runs-on: ubuntu-latest

    env:
      TEMPLATE_FILE: cloudformation-openvpn-vpc.yaml
      AWS_REGION: us-east-1

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        if: ${{ !secrets.AWS_ACCESS_KEY_ID }}
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Configure AWS credentials (static keys fallback)
        if: ${{ secrets.AWS_ACCESS_KEY_ID }}
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Validate template
        run: |
          aws cloudformation validate-template --template-body file://$TEMPLATE_FILE

      - name: Deploy stack
        run: |
          STACK_NAME=${{ github.event.inputs.stack_name || 'openvpn-dev' }}
          ENV_NAME=${{ github.event.inputs.environment_name || 'dev' }}
          VPC_CIDR=${{ github.event.inputs.vpc_cidr || '10.20.0.0/16' }}
          PUB_SUBNET=${{ github.event.inputs.public_subnet_cidr || '10.20.1.0/24' }}
          ALLOWED=${{ github.event.inputs.allowed_client_cidr || '0.0.0.0/0' }}
          INSTANCE_TYPE=${{ github.event.inputs.instance_type || 't3.micro' }}
          KEYPAIR=${{ github.event.inputs.key_pair_name || 'my-keypair' }}
          BUCKET=${{ github.event.inputs.bucket_name || 'my-unique-openvpn-bucket' }}
          ARCH=${{ github.event.inputs.architecture || 'arm64' }}

          aws cloudformation deploy \
            --stack-name "$STACK_NAME" \
            --template-file "$TEMPLATE_FILE" \
            --capabilities CAPABILITY_NAMED_IAM \
            --parameter-overrides \
              EnvironmentName="$ENV_NAME" \
              VpcCidr="$VPC_CIDR" \
              PublicSubnetCidr="$PUB_SUBNET" \
              AllowedClientCidr="$ALLOWED" \
              InstanceType="$INSTANCE_TYPE" \
              KeyPairName="$KEYPAIR" \
              BucketName="$BUCKET" \
              Architecture="$ARCH" \
              LatestAmiId="/aws/service/ami-amazon-linux-latest/al2023-ami-kernel-default-$ARCH" \
            --no-fail-on-empty-changeset

      - name: Stack outputs
        run: |
          STACK_NAME=${{ github.event.inputs.stack_name || 'openvpn-dev' }}
          aws cloudformation describe-stacks --stack-name "$STACK_NAME" --query 'Stacks[0].Outputs' --output table

      - name: Advise retrieving client config
        run: |
          echo "After the instance finishes bootstrap (can take a few minutes), download the client profile:";
          echo "aws s3 cp s3://$({ echo ${{ github.event.inputs.bucket_name || 'my-unique-openvpn-bucket' }})/client1.ovpn .";
